#!/usr/bin/env python3
# Author: Yonglin Wang
# Date: 2021/4/28 5:57 PM

import argparse
from typing import List, Any
import json
import sys

import numpy as np
import torch
from transformers import LongformerModel, LongformerTokenizer

# https://huggingface.co/transformers/model_doc/longformer.html

LONGFORMER_DEFAULT = 'allenai/longformer-base-4096'
TRANSFORMERXL = 'transfo-xl-wt103'
LF_VECTOR = "lf_vector"

class LongformerEmbedding:
    def __init__(self, model_name: str) -> None:
        """
        wrapper for loading sentence BERT embeddings (https://github.com/UKPLab/sentence-transformers)
        :param model_name: pretrained model name, check (https://huggingface.co/transformers/pretrained_models.html) for other options
        """
        try:
            self.model = LongformerModel.from_pretrained(model_name)
            print("Model loaded Successfully !")
        except Exception as e:
            raise ValueError(f"Error loading Model {model_name}, " + str(e))
        try:
            self.tokenizer = LongformerTokenizer.from_pretrained(model_name)
            print("Tokenizer loaded Successfully !")
        except Exception as e:
            raise ValueError(f"Error loading Tokenizer {model_name}, " + str(e))
        self.max_len = self.tokenizer.model_max_length

    def _single_encode_text(self, text: str) -> np.array:
        """tokenize and encode a single content string"""
        input_ids = self._tokenize_text(text)
        print(f"id length: {len(input_ids[0])}")
        try:
            text_embeddings = self.model(input_ids)
        except IndexError as e:
            print(f"input text: {text}")
            print(f"input inds: {input_ids}")
            raise e
        return text_embeddings.pooler_output.detach().numpy()

    def _tokenize_text(self, text: str) -> torch.Tensor:
        """tokenize text and return Tensor of token IDs"""
        # specify max length truncation to avoid IndexError due to exceeding length
        return torch.tensor(self.tokenizer.encode(text, max_length=self.max_len, truncation=True)).unsqueeze(0)

    def encode(self, texts: List[str], pooling: str = "mean") -> np.array:
        """
        :param texts: list of texts
        :param pooling: default "mean", placeholder to keep consistent with
        :return:
        """
        doc_embeddings = np.vstack(
            [self._single_encode_text(text) for text in texts]
        )
        return doc_embeddings


def add_lf_vector(original_wapo_jl_path: str, output_jl_path: str):
    lf = LongformerEmbedding(LONGFORMER_DEFAULT)

    with open(output_jl_path, "w") as fout:
        for line in open(original_wapo_jl_path, "r"):
            doc = json.loads(line)
            print(f"now converting doc {doc['doc_id']}")
            content_embed = lf.encode([doc["content_str"]])[0].tolist()
            doc[LF_VECTOR] = content_embed
            fout.write(f"{json.dumps(doc)}\n")


if __name__ == "__main__":
    print(f"input file: {sys.argv[1]}\noutput file: {sys.argv[2]}")
    add_lf_vector(sys.argv[1], sys.argv[2])
    # lf = LongformerEmbedding(LONGFORMER_DEFAULT)
    # test = "Correction: An earlier version of this article incorrectly described a doctor’s specialty. Nathan Zasler is a specialist in brain-injury medicine, not a neurologist. This version has been corrected. The dark-oak farmhouse table where Page and Robert Melton spent many a dinner hour is now laden with vases and framed pictures, fragile pieces of their life together that have to be tucked into cardboard boxes. The movers are coming in the morning and, with much still to pack, Page thinks she could be looking at another all-nighter. She picks up a sepia-toned drawing of blackbirds. They gave each other art in the early years of their marriage, and this was the first thing Page had given Robert. Next, a photo of Robert standing in front of the Virginia statehouse, looking every inch the formidable journalist he was, a guy who could intimidate colleagues with a dipped chin and glance over wire-rimmed glasses. (Page Melton and Susan Baer took questions from readers in a Live Q&A on Monday, January 9. Read the transcript.) The next photo is one of her favorites: Robert with family members by the porch of their homey Dutch colonial in Richmond on the morning of their younger daughter’s christening, in September 2002. A brilliant fall day, it was exactly one year before the heart attack and collapse that left the 46-year-old father of two with a brain injury so severe he would eventually live in an assisted living facility. How often Page had stared at that photo. Was he ill then? she’d wonder. Was there something she could have seen? Should have seen? Page shakes off the thought and rolls bubble wrap around the photo, much as she has tried to cushion the hard edges of the part of their bifurcated life they refer to as “after the injury.” Robert had come a long way since 2003, when he looked at his wife sitting by his side in the hospital and said, “You seem like a nice lady. How come you’re not married?” She had gone home that day and put away the diamond and emerald ring he had given her when he proposed. Looking at it made her too sad. Seven years later Robert was still mentally impaired and his personality far different than before the accident, but he knew his family, knew he had had a brain injury that upended their lives, and asked lots of questions. He carried with him at all times a reporter’s notebook, in which he had written the information most important to him: his daughters’ ages — 9 and 11 — and that he has “known my honey” 18 years. He could remember snippets of his pre-injury life — the made-up song he and Page sang to their girls, his nicknames for colleagues, that he had been an Eagle Scout. And though he still broke Page’s heart every day with a sweet and childlike simple-mindedness — repeating his plans to “take meds, wash hands and brush teeth” like a mantra, or excitedly announcing that he’d won a candy bar at a penny toss “and didn’t cheat at all” — once in a while, he would say something insightful and completely on point. Just days earlier, at the Sunrise assisted-living facility where he lived for several years, Robert had looked at Page with earnest eyes and the relaxed demeanor he used to have and asked if it was hard for her to pack up the house: “Does that cause you distress, darlin’? Make you sad?” Page took his hand, and her eyes filled with tears. “We had the best days of our lives and the worst days of our lives in that house,” she said quietly. “So, it’s very bittersweet to leave it.” “It is bittersweet,” Robert echoed. The girls were so young when Robert fell ill — Hope was 3 and Nell 18 months — that Page was the only one of the four who remembered those days. Page alone knew that Robert loved to work in the yard and tend the azaleas. Or that he liked to write his weekly Virginia politics column in the garage. Or that he held Hope on his lap as he read the New Yorker, letting the quiet daughter who was so much like him point to letters she recognized. Page was the only one who remembered the day in September 2003 when, just home from the hospital after the heart attack, Robert hugged her in the kitchen and told her everything was going to be all right. Or the moment a day later when he collapsed and stopped breathing. Wrapping up the contents of their home on the eve of moving day — and the beginning of a new chapter in their lives — Page couldn’t help but reach back to those best and worst of times, and one other memorable day: On a Saturday morning in the spring of 2010, Page had arranged for Robert to come home from Sunrise for breakfast. She had asked Robert’s brother Will to drive down from Annandale to be with them and sent the girls out for the morning with Allan Ivie, a friend from childhood who had come back into her life. She had consulted with Robert’s doctors and her minister. She cooked up some eggs. She was nervous as she sat down at the big oak table next to her husband of 16 years. Then she had a conversation with Robert she had never imagined she could have. * * * During the eight weeks Robert Hamilton Melton spent at a rehabilitation hospital in Hanover, Va., after his brain injury, he would often pick up a notepad and pen, wander into another patient’s room and start talking. Before he remembered anything about his personal life, he remembered he had been a reporter. Writing under the byline R.H. Melton, Robert, 54, had built his career at The Washington Post, where he worked since 1982 as an editor and a reporter, primarily covering politics in Maryland, Virginia and the District. (He was a colleague of and became a close friend of my husband’s.) He was considered the institutional memory, a thoughtful editor and an elegant writer who was often the go-to guy on breaking stories. In Richmond, where he worked during the final years of his career, he broke stories that rattled the political landscape: One led to the resignation of the speaker of the House of Delegates in 2002, and another resulted in the federal conviction of a former executive director of the Virginia GOP. The Post nominated him for a Pulitzer Prize for beat reporting that year; in 2009, he was inducted into the Virginia Capitol Correspondents Association Hall of Fame. At 6-foot-5, Robert was an imposing presence, both supremely self-contained and reserved. He listened more than he talked, and he didn’t mind that he intimidated people. “He could be very haughty and very snide,” Bob Lewis, a reporter for the Associated Press in Richmond, says affectionately. “He did that to new people, just to see if they could roll with it. If you let it get under your skin, you failed the Robert test.” But beyond the tough exterior was a wickedly funny and loyal colleague and friend. Growing up in Springfield, the second of five boys born to Mary Hope, a homemaker, and Eston Melton, a chemical engineer, Robert had a knack for language from an early age. At Annandale High, he worked on the school paper, as he did later at the University of Virginia, and, at 17, won a statewide oratorical contest with a defense of the First Amendment. Page Boinest, a Richmond native and fellow graduate of U-Va., had met Robert in the mid-’80s when she was a junior reporter with UPI helping cover a special session of the Virginia legislature. Through the years, the two crossed paths, and friends even set them up on a date, but they didn’t hit it off. Page found Robert private, hard to get to know. In 1990, Page left UPI to join the staff of then-Maryland Gov. William Donald Schaefer, first as his speechwriter, later as his press secretary. At a business dinner in Annapolis with Robert in 1992, something changed. “I don’t know how to describe it, but there was this chemistry between us — it had never been there before,” says Page, now 51. Married in 1995, their life together was a carefree mix of travel, work, politics. Their first daughter, Virginia Hope, was born in 2000, followed two years later by Nell Hamilton. On that day in April 2002, Robert handed their new baby girl to Page. “Now our family’s complete,” he told her. It was the happiest day of Page’s life. * * * On its destructive path up the East Coast in September 2003, Hurricane Isabel ripped through central Virginia, downing trees and leaving thousands, including the Meltons, without power for days. From his office near the Capitol, Robert was writing story after story about the devastation. He had spent days clearing out his own back yard and was surprised at how tired the work made him. He was working at his office on Saturday, Sept. 20, when his chest started to hurt. He thought perhaps he had eaten bad salami for lunch, but since he’d had a heart scare before — in 1997, he had been hospitalized with an irregular heartbeat — he walked across the street to the emergency room at the Medical College of Virginia, now Virginia Commonwealth University Medical Center. He was having a heart attack. On Monday, doctors implanted a stent in one of his coronary arteries. Two days later, on his 46th birthday, he was allowed to go home. A day later, the power finally came back on in their home. Robert and Page were in the kitchen when Robert pulled his wife into his arms and reassured her: “Everything’s going to be okay now. We got the power back, and I’m home.” But the next day, Friday, Sept. 26, at about 4 p.m., the life they had known ended. Page was making dinner. Nell was in a high chair at the dining room table. Robert bent over the chair to scoot it in and suddenly dropped to the floor. The children started screaming. Page called 911. Robert was barely breathing — then stopped. Page tried CPR. Neighbors came. Power crews in the area came in and tried to help. Page remembers a big burly man holding her 18-month-old. Still no ambulance. A sheriff’s deputy came in and tried to revive Robert. “He was gone,” Page says. Finally, after a half-hour, the volunteer rescue squad showed up. There had been so many cases of chest pains because people had been out clearing their yards that the emergency crew was stretched thin. Page jumped into the ambulance, and it headed to Henrico Doctors, the nearest hospital, about 20 minutes away. Henrico was overflowing and tried to divert the ambulance to MCV downtown. Page screamed at the driver: No, he’ll never make it if you go downtown — just go to Henrico Doctors. The driver did. But Robert had been down for about 45 minutes. When the cardiologist came to talk to Page, he told her, “I can revive him, but you’re not going to want me to.” She had to decide on the spot. “Bring him back to me,” she told the doctor. “Bring him back to us.” After about 20 minutes, the doctor came out. Robert was in a coma and on life support. The collapse was likely caused by a blood clot thrown off by the stent, doctors said, and Robert would either not make it, survive in a persistent vegetative state or, best-case scenario, come back but not resemble the man she knew. After three days, Robert woke up. He was talking, mumbling, whispering, but none of it made sense. He didn’t know who anyone was. Still, nurses told Page stories of miracles, people who came all the way back. She clung to those. Doctors told Page that most of whatever progress Robert would make would be in the first year; the lack of oxygen to his brain had caused hypoxic-ischemic brain injury, moderately severe. Robert spent several weeks at Henrico Doctors, where he had a defibrillator put in, then was transferred to a rehabilitation hospital. He’d had little physical impairment, but his cognitive loss was profound. He had severe language problems, couldn’t sit still, was confused and frustrated to the point of violence. And he had no memory — short- or long-term. The therapists tried all sorts of tools for dealing with the memory loss. They made him a “memory book.” They made him lists. One gave him a PalmPilot. Nothing worked. Then one day, Page brought him stories he had written, newspapers, reporters’ notebooks, his tape recorder. He picked up one of the pads, started writing in it, and popped it into his back pocket. For the first time, he remembered something: “I was a reporter. I was a writer, wasn’t I?” After a month in rehab, Robert spent eight weeks at a residential facility for brain-injury patients in North Carolina. By January 2004, he had made enough progress to go home, but after about five months at home, the progress slowed. He could speak and read and write, but he couldn’t hold onto the meaning behind words. He had little judgment or control over his behavior and was increasingly frustrated. “He didn’t remember his former life,” says Page, “but he knew it was something more than he had at the time.” Doctors told Page that Robert would benefit from someplace with regular activities and a set schedule — a routine that was difficult at home with two small children — as well as caregivers to manage his medications and his own space to recover in. The only long-term choices were a nursing home or an assisted-living facility. “At that point, it was like the dream died,” Page recalls. “It was very hard, because when Robert came home, you have this not-even-rational thought that, ‘If I just love him enough, he’ll get better.’ ” There are not many brain-injury patients at assisted-living facilities, not many healthy 46-year-olds bounding around with lots of energy. So the Meltons had to make it up as they went along when Robert entered Brighton Gardens in Richmond. The first year was difficult. Robert’s presence unsettled the older, feebler residents. He would complain to Page that bingo was boring or that there wasn’t much to do. He struggled with his temper. But, over time, the routine began to ease Robert’s anxieties and help him function. A checklist on his medicine cabinet, “Robert’s Recipe for a Handsome Husband,” reminded him to shower, shampoo and shave, and caregivers — as well as a companion Page hired to provide stimulation — helped him accomplish those tasks. He ate meals at the same table with the same group of men, all decades older than he. Eventually, he started to embrace the activities — from beading to Bible studies, even bingo — and slowly his irritability evolved into a warm, jolly nature. “At some point, he just gave himself up to it,” Page says. “And that was huge to me, because I was beating myself up about the fact that he wasn’t at home anymore.” Page visited Robert every day at first and eventually every other day, and the girls came for lunch every Saturday. When Brighton Gardens was sold to another company, Robert moved to Sunrise along with much of the staff, which had grown to love him and his family. Today, he looks healthy and fit, and walks with confidence. Page makes sure he dresses well, and glasses at the end of his nose still give him a professorial look. But within seconds of meeting him, it’s clear his mind is impaired. It’s hard to know how much he comprehends, even when he answers a question. Conversations are limited and disjointed. He sometimes latches onto the sounds of words rather than their meaning — saying, “Give my regards to Broadway,” for instance, when he’s told a friend “sends his regards.” He often falls back on stock phrases or song lyrics. The most striking thing about Robert is his personality. Once reserved and a bit aloof, Robert today is talkative and exuberant. He seems to spill over with wide-eyed joy and gratitude. He calls everyone “darlin’ ” or “babe” or “bro.’” “Mabel, I cannot thank you enough for that toilet tissue,” he’d say to the short Colombian woman who cleaned his room at Sunrise. His outsize gregariousness — a reflection of an “organic personality disorder,” says Nathan Zasler, his brain injury medicine specialist — enlivened the quiet halls full of wheelchairs and walkers there. As did his family. Once, Page brought in leis and sunglasses, and grass skirts for the girls, so the four of them could lip-sync “Cheeseburger in Paradise” at the Sunrise talent show. “We brought the house down, didn’t we?” she says to Robert on a later visit. It sparks something else. “Do you know what I remember?” he asks Page. “I remember the Sailboat Song. Did you come up with that, darlin’?” It was the made-up song they sang to their daughters at night. Sitting together in the assisted-living home, Page starts to sing it softly, and Robert joins in, tapping time on the table and staring off into the distance: All I want is a sailboat day. And we’ll head toward the Chesapeake Bay. And we’ll laugh all the way. Oh, won’t it just be wonderful.  “After my injury, did the girls ever join in the chorus, hon?” Robert asks. “I don’t know,” Page says. “But after you were in the hospital, I kept singing it, because it reminded them of you.” * * * As Hope and Nell got older, they seemed to miss the presence of a father more. But they were smart, well-adjusted kids, and Page believed that although they didn’t have the benefit of Robert’s intellect, they picked up something just as valuable — a sense of compassion — from the father who made them beaded bracelets and gave them the candy bar he had won as a prize. Page had made her peace with her life. She had lost her taste for politics — half the fun had been discussing it with Robert, she says — but she worked full time as a government-affairs consultant. On the side, she became an advocate for brain-injury and caregiver groups. She testified before the Virginia legislature — to lawmakers who had known Robert — seeking a Medicaid brain-injury waiver so there could be more resources and residential options for patients. Many such patients end up in mental institutions, she learned, because there are so few alternatives. The Meltons were lucky. With her salary, Robert’s disability and Social Security payments, and, if necessary, help from her parents, they could afford assisted living. The advocacy work helped her heal. “I had made up my mind: ‘This is what our life is going to be, and I’m okay with that,’ ” she says. “ ‘We’re okay, the children are doing well, Robert’s happy. We can survive this way.’ ” She didn’t go out much socially, but in June 2008 she attended her 25th college reunion in Charlottesville. At a cocktail party, she reconnected with Allan D. Ivie IV, a U-Va. classmate she’d known since kindergarten, who was now a banker and father of four sons living in St. Louis. They had been good friends as kids, co-editors of the high school newspaper, so it was easy to talk to Allan, tell him about the event that had defined her life for the past five years. Regretting that he’d been out of touch with Page, he vowed to contact her the next time he was in Richmond to visit his mother. Six months later, he did. And soon after, with Allan in the midst of a divorce, they began talking regularly. It was nice to have an adult to talk to, Page says, and she began to wrestle with feelings that they could be more than friends. “It had never occurred to me at that point to be in a relationship,” she says. “It felt disloyal to Robert.” Allan, too, was grappling with his feelings. He recalls that early on Page told him she was resigned to being alone with the girls for the rest of her life. “I said, ‘You can’t. Your heart is way too big for that.’ ” He realized that the only way their relationship could develop was if it included Robert. As he started falling in love with Page, he said to her: “I see this responsibility that you have, and I want to help you with it. I understand this is a package deal.” “That’s what triggered the relationship,” Page says. “He understood that Robert was central to our lives, that we needed to take care of him.” Page eventually introduced Allan to Robert, and Allan worked to forge his own relationship with Robert, writing him an e-mail every day and taking him to breakfast at IHOP, Robert’s favorite, whenever he was in town. Allan felt uneasy at first, guilty about befriending a man with limited cognition while starting up a romance with his wife. Page tiptoed into the subject of dating with Robert, telling him that she and Allan were beginning to be more than just friends, and asking if he understood and was comfortable with that. Robert told her it was fine. “He’s a really nice guy,” Page says he told her. Allan started visiting every other weekend. He and Page would cook together and go for runs. They would take the girls hiking or on day trips. Allan put up a swing in the back yard and played soccer with the girls. Page felt 30 again but was racked with guilt. “I believed my vows so strongly that they just kept ringing in my ears.” She consulted her minister, who told her that by continuing to take care of Robert, she was still honoring those vows. In March 2010, Allan and Page and the girls went skiing at the Homestead Resort in southwestern Virginia. Page watched from behind as Allan helped her daughters navigate the slopes, skiing with one girl on either side of him. “It hit me like a thunderbolt,” she says. “I’m watching him with these two girls, and I thought, here’s an unusual man, and a patient man, and a kind man, and a very loving man — and I felt my heart just lift.” They started having whimsical talks about marriage, but merging families seemed too complicated. Allan, now divorced, couldn’t leave St. Louis, where he had joint custody of his three youngest sons, and was about to become president of Reliance Bank. And Page’s support system — her parents, her sister and brother — were all in Richmond. And there was Robert. Marriage would require divorce. Page couldn’t imagine that. But another thought eased her mind: “I knew if something happened to me, Allan would take care of Robert, and the girls, of course.” In June, Allan proposed. Page said yes, though she still couldn’t wrap her head around how it would work. Eventually, they came up with a plan. Page and the girls would move to St. Louis. And Robert would come with them. “For all the good of Richmond and the support we’ve had, we’ve all been sort of defined by the injury,” Page said last spring. “So, we’ll go, and the girls will have the benefit of Robert’s relationship but also grow up in a house with Allan and all the things that you do as a family.” The girls had grown to love Allan, Page says. But their first question was, “What about Daddy?” Page told them that their father would be as much a part of their lives as he had always been. They had questions about school and leaving their relatives and friends, but they also had the same sense she did that this could be good, says Page, “that life doesn’t have to be this grim and tough.” Page discussed the plans with Robert’s brother Will, who had been a regular visitor through the years, and his father and stepmother. “We had anguished a lot about the fact that Page was trapped — trapped by her love for Robert and overwhelming sense of loyalty to him,” said Eston Melton, who had been divorced from Robert’s mother when she died in 2002. “She had no life whatsoever, and those two girls did not have any kind of father image in their upbringing. So, we were very comfortable with the new relationship. More than comfortable; we encouraged it.” Page talked to Zasler, the doctor, who thought Robert could deal with the new arrangement and counseled her to emphasize that she and the girls would still be there for him. The only thing left was to tell Robert. * * * Page says she was a nervous wreck on the June 2010 morning when Will brought Robert to the house. She’d gone over the conversation dozens of times in her head but still couldn’t imagine saying the words out loud. Finally, she started: “I’ll always love you, and we’ll always take care of you.” “I know that,” Robert said. She took a sip of coffee. “You know that Allan and I have been seeing each other, and we have a relationship and we love each other, and he’s asked me to marry him.” Robert responded immediately: “You should marry him. He’s a good guy.” Then he asked what would happen to him. Page explained that they would all move to St. Louis, where she’d already found a Sunrise facility close to their home. Their family would be the same, she told him, only bigger. A week later was Father’s Day, and Nell drew a picture, titled “my family,” with all nine of them, including her four stepbrothers-to-be: “Allan, Dad, Mom, Hopie, Me, Harrison, Peter, Chris, Charlie.” “If the youngest person in the family can grasp that this is what the picture looks like,” Page thought to herself, “then we’ll be okay.” Page never used the word “divorce” with Robert, but that would have to be the next step. She hired a lawyer for herself and another one for Robert, and asked Will to represent Robert along with a guardian ad litem appointed by the court. The divorce was final in early 2011. Page wanted to remain Robert’s legal guardian, as she had been since his injury, and no one objected. Will signed for Robert. On the morning of March 26 last year, Allan and his youngest son, Charles, took Robert to breakfast at IHOP. That evening, Page and Allan married in a small 19th-century chapel at St. Mary’s Episcopal Church in Richmond in front of about 100 people, including Robert’s father and stepmother, and his brother Will and his wife. But not Robert. “I just could not have done that,” Page says. “It broke my heart to not be married to Robert anymore, in spite of all the good that was going to happen.” As Allan held Page’s hands, he promised to always love her and her daughters. He turned to Hope and Nell, who were their mom’s attendants, and smiled. Then he looked back at Page: “And I promise to always help you provide compassionate care for Robert.” The words seemed to unleash the emotions of the day. Will Melton, an assistant director with the Marine Corps, said he and his father — and everyone in the church including the minister — were moved to tears. “Allan’s vows were so touching,” Will said. “It was very uplifting in that regard — but also kinda sad.” Page thinks Robert accepted the new expanded family. “On some level, it didn’t matter to him,” Page says. At an appointment to switch the battery in his defibrillator before he left Richmond, Robert, with Page by his side, was asked if he was married or single. “Single. ... My lady’s married to someone else now,” he said. Page looked at Robert. “Are you okay with that?” “I’m fine with that,” he said, cheerful as ever, Page says. Page says there have been a thousand moments like that, when she has felt almost apologetic and wanted to explain. “In a way, I feel married to Robert forever,” she said a few days before leaving for St. Louis. “It’s not a traditional marriage. It’s not the marriage we signed up for. But I feel like there’s a connection there that never ends.” In June of last year, Page and the girls moved into the five-bedroom ranch house she and Allan had bought in the St. Louis suburb of Creve Coeur. They outfitted Robert’s room at Sunrise to look exactly like his room in Richmond: same layout, same photos, same bulletin board with “No. 1 Dad” sign. Later that month, Page traveled back to Richmond to fly with Robert to his new home. The Richmond Sunrise staff showered him with tributes, a photo album and tearful good-byes. With Will at the wheel, Robert hopped into the car as well-wishers followed him out the door. “Peace on earth,” he sighed happily, settling back in his seat. “Peace on earth.” * * * Nell runs to Allan when he gets home from work, gives him a hug, and tells him about the scary tornado movie she and Hope saw that day at the St. Louis Science Center’s IMAX theater. The girls have had to give up “Cake Boss,” their favorite TV show, for “Deadliest Warrior” on the Spike channel, but they’re happy to make the concession to hang out with their new stepbrothers. Page is still working as a consultant, out of an office at home. She has had to learn to cook for more people, and for boys. She laughed when Harrison, a track star who started last fall at the University of Arizona, ate all the pork tenderloin leftovers for breakfast. Robert seems to be adapting best of all, Page and Allan both say. He takes part in everything from the walking club to the puzzle group at Sunrise. “I’ve got the calendar of today’s activities, and I have done the whole nine yards,” he tells Page one afternoon. “Aren’t you proud of me, darlin’?” Page still sees him several times a week, taking him out or to the house, bringing him iced tea for his refrigerator or books of word searches. Allan writes him e-mails every day and takes him to breakfast every Wednesday. “All right, Robert, my man, you going for the omelet again?” Allan asks as they settle into a booth at their regular breakfast place one Wednesday in August. Allan tells him about the St. Louis Arch; Robert asks if Allan’s son Peter is named after the singing trio Peter, Paul and Mary. Toward the end of breakfast, Robert asks, “Mama’s doing well, Allan?” “Yeah,” Allan says. “She’s doing okay.” Allan acknowledges that there’s some awkwardness in their unorthodox family. He wonders how much Robert truly comprehends, since he still sometimes refers to Page as his wife. Allan’s friends haven’t asked him directly, “Why are you doing this?” But he says they often look on with amazement at his embrace of Robert. It’s not an act of altruism, he says: “Truthfully, it came down to realizing that if I wanted to spend the rest of my life with Page . . . that was a pretty big incentive to do it.” Page, now Page Melton Ivie, walks gingerly between her former and current husband, trying not to hurt anyone’s feelings. She says that, in a way, Robert has grasped the essence of their relationship better than any of them. He understands, she says, “that it’s not the legal arrangement, it’s the emotional arrangement, that emotional commitment.” Robert’s father, who had worried that the blended family “could have easily tanked,” says he was heartened by how well it all seemed to be working when he and Will visited in September for Robert’s birthday. “It was almost like a miracle.” Zasler says Robert’s case has been unusual in that he has continued to improve years after his injury — a consequence, the doctor thinks, of Robert’s strength, medications and rehabilitation, and Page’s devotion. “A lot of times, family members pack up the bag and run the other way,” he says. “Page’s support for Robert kind of exemplifies what true love is all about.” For years after Robert’s injury, Page was sustained by the notion that she would see him again after she died, the man who turned her head in the press room and loved poetry and handed her their newborn babies. “We’d be able to talk through all this stuff, and I’d be able to say, ‘Well, I hope it worked out okay, that the decisions were the right ones, and that you were happy.’ ” She’s comforted that Robert seems content. That’s what has made her own happiness possible. Friends used to assume that the holidays were the hardest times for her. But it was really the motions of everyday life. Now that’s what brings her the greatest joy: making breakfast, setting the table — the long oak table from her dining room in Virginia that now sits in the sunny kitchen. There they all clasp hands to say grace before dinner. The table is big enough to accommodate all of them. Susan Baer is a Washington writer. She can be reached at wpmagazine@washpost.com. Baer and Page Melton chatted live with readers on Monday, January 9. Read the transcript."